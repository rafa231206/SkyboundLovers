<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Skybound Lovers</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196F3">
  <style>
    /* Global Styles */
    *, *::before, *::after {
      box-sizing: border-box; /* Ensures consistent box model */
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(to top, #a0d8f1, #e0f7ff); /* Default theme */
      font-family: 'Press Start 2P', cursive;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      height: 100%;
      transition: background 0.5s ease-in-out; /* Smooth background transition */
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
    }

    .no-transition {
      transition: none !important; /* Utility class to disable transitions */
    }

    canvas {
      display: block;
      margin: 0 auto;
      background-color: #b3e5fc; /* Default canvas background */
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
      height: 600px;
      transition: background-color 0.5s ease-in-out;
      touch-action: none; /* Prevent default touch actions */
      position: relative;
      z-index: 1;
    }

    /* Parallax background layers for canvas */
    canvas::before, canvas::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      transition: all 1.5s cubic-bezier(0.215, 0.61, 0.355, 1); /* Smooth parallax transition */
      z-index: -1;
      background-size: cover;
      background-position: center;
      pointer-events: none; /* Ensure layers don't interfere with canvas interaction */
    }

    /* Theme 1: Buildings */
    canvas.theme-buildings {
      background: linear-gradient(to top, #87CEEB, #ADD8E6);
      box-shadow: inset 0 0 100px rgba(135, 206, 235, 0.6);
    }
    canvas.theme-buildings::before {
      background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/504ea317-e0a0-4a72-a92a-ccdcfcbc6893.png');
      opacity: 0.6;
    }

    /* Theme 2: Birds */
    canvas.theme-birds {
      background: linear-gradient(to top, #4B0082, #9400D3);
      box-shadow: inset 0 0 100px rgba(75, 0, 130, 0.6);
    }
    canvas.theme-birds::after {
      background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/ed8cb5e3-2b89-47bb-9c86-80d2a449f7a3.png');
      animation: float 15s linear infinite;
    }

    /* Theme 3: Space */
    canvas.theme-space {
      background: linear-gradient(to top, #000000, #000033);
      box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.8);
    }
    canvas.theme-space::before {
      background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/8f111458-08a8-45c6-afbb-5de16e209a41.png');
      animation: twinkle 5s ease-in-out infinite;
    }
    
    /* Animations */
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    @keyframes moveHorizontal {
      0% { transform: translateX(0); }
      100% { transform: translateX(50px); }
    }

    @keyframes moveVertical {
      0% { transform: translateY(0); }
      100% { transform: translateY(30px); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes glow {
        0% { text-shadow: 0 0 5px #ff0; }
        50% { text-shadow: 0 0 15px #ff0, 0 0 10px #fa0; }
        100% { text-shadow: 0 0 5px #ff0; }
    }

    @keyframes particle-fade {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-20px) scale(0.5); }
    }

    /* Platform Styles (Clouds) */
    .game-platform {
      position: absolute;
      background-color: #ffffff; /* Default, overridden by .platform-cloud */
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 2;
      transition: background-color 0.3s ease;
    }

    .platform-moving-horizontal {
      animation: moveHorizontal 8s ease-in-out infinite alternate;
    }

    .platform-moving-vertical {
      animation: moveVertical 6s ease-in-out infinite alternate;
    }

    .platform-small-obstacle {
      background-color: rgba(255, 255, 255, 0.7) !important;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
    }

    .platform-cloud {
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.9), rgba(240, 240, 240, 0.8));
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1), inset 0 0 10px rgba(255, 255, 255, 0.5);
      position: relative;
      overflow: hidden;
    }

    .platform-cloud::before, .platform-cloud::after {
      content: '';
      position: absolute;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      opacity: 0.7;
      filter: blur(5px);
    }

    .platform-cloud::before {
      width: 70%;
      height: 70%;
      top: -30%;
      left: -20%;
    }

    .platform-cloud::after {
      width: 60%;
      height: 60%;
      bottom: -30%;
      right: -20%;
    }

    .platform-disappearing {
      transition: opacity 0.5s ease-out;
    }

    /* Screen Overlays (Start, Game Over, Pause) */
    #startScreen, #gameOverScreen, #pauseScreen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
      background: rgba(0,0,0,0.8);
      padding: 20px 20px 60px;
      border-radius: 25px;
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
      border: 3px solid #2196F3;
      max-width: 90%;
      width: 350px; /* Fixed width for better consistency */
      box-sizing: border-box;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      z-index: 10;
    }
    #startScreen.show, #gameOverScreen.show, #pauseScreen.show {
        opacity: 1;
    }
    #gameOverScreen {
        border: 3px solid #ff4081;
        padding-top: 70px;
    }
    #startScreen h1, #gameOverScreen h2, #pauseScreen h2 {
        font-size: 1.8em;
        color: #FFD700;
        text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        margin-bottom: 20px;
    }
    #gameOverScreen h2 {
        color: #FF4081;
        position: relative;
        margin-top: 10px;
    }
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #000;
      color: #fff;
      font-family: 'Press Start 2P', cursive;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    /* Character Selection */
    .character-options {
      display: flex;
      flex-direction: row; /* Tetap row untuk tampilan desktop */
      gap: 20px;
      margin-top: 20px;
      justify-content: center; /* Pusatkan secara horizontal */
      flex-wrap: wrap;
      align-items: flex-start; /* Pusatkan secara vertikal di awal baris */
    }
    
    .character-card {
      padding: 15px;
      border-radius: 20px;
      background: rgba(255,255,255,0.15);
      transition: all 0.4s ease;
      cursor: pointer;
      border: 2px solid transparent;
      /* flex: 1 1 45%; */ /* Hapus atau komentari ini */
      min-width: 120px;
      max-width: 180px;
      box-sizing: border-box;
      margin: 5px;
      display: flex; /* Tambahkan ini */
      flex-direction: column; /* Tambahkan ini */
      align-items: center; /* Pusatkan konten card */
      text-align: center; /* Pusatkan teks di dalam card */
    }
    .character-card:hover {
      transform: translateY(-5px) scale(1.05);
      background: rgba(255,255,255,0.3);
      border: 2px solid #FFD700;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    .character-card.selected {
      border: 2px solid #FFD700;
      box-shadow: 0 0 15px #FFD700;
      transform: scale(1.05);
    }
    .character-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #fff;
      margin-bottom: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* Buttons */
    .main-button {
      padding: 15px 30px;
      background: linear-gradient(135deg, #FF416C, #FF4B2B);
      font-size: 1em;
      margin: 20px auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      border: 2px solid #FFD700;
    }

    .back-button {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      margin-top: 20px;
    }

    .character-button, .game-over-button, .main-button, .back-button, .pause-button {
      padding: 10px 20px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(45deg, #2196F3, #00BCD4);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Press Start 2P', cursive;
      font-size: 0.8em;
      text-transform: uppercase;
      letter-spacing: 1px;
      width: 100%;
      box-sizing: border-box;
    }
    .character-button:hover, .main-button:hover, .back-button:hover, .pause-button:hover {
      background: linear-gradient(45deg, #1976D2, #0097A7);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }

    .main-button {
      animation: pulse 1.5s infinite;
    }
    
    /* Score Displays */
    #finalScore {
        font-size: 1.2em;
        margin-bottom: 20px;
        color: #FFD700;
    }
    #highScoreDisplay {
        font-size: 1.4em;
        margin: 15px 0;
        padding: 15px;
        color: #FFD700;
        background: rgba(0,0,0,0.7);
        border-radius: 10px;
        border: 2px solid gold;
        box-shadow: 0 0 15px rgba(255,215,0,0.5);
        text-shadow: 0 0 5px #ff0;
        animation: pulse 1.5s infinite;
        transform: scale(1.1);
    }

    .new-highscore {
        animation: glow 1s infinite, pulse 0.5s infinite !important;
        color: #ffcc00 !important;
        background: rgba(255,0,0,0.2) !important;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }
    .game-over-button {
      background: linear-gradient(45deg, #ff4081, #e91e63);
      font-size: 1em;
      margin-top: 0;
    }
    .game-over-button:hover {
      background: linear-gradient(45deg, #e91e63, #c2185b);
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    /* Popups */
    #coinMilestonePopup {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: auto;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      z-index: 100;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(255,255,0,0.9);
      border: 3px solid #FFD700;
      max-width: 80%;
    }

    #scoreDisplay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        font-family: 'Press Start 2P', cursive;
        font-size: 0.8em;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        border: 2px solid #FFD700;
        z-index: 50;
    }
    #scoreDisplay img {
        width: 20px;
        height: 20px;
        vertical-align: middle;
    }
    #scoreDisplay span {
        margin-left: 3px;
        color: #FFD700;
    }

    #livesDisplay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      border: 2px solid #FFD700;
      z-index: 50;
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .life-icon {
      width: 25px;
      height: 25px;
      filter: drop-shadow(0 0 5px rgba(255,0,0,0.7));
    }

    #pauseButton {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 8px 15px;
      border-radius: 10px;
      font-family: 'Press Start 2P', cursive;
      font-size: 0.8em;
      border: 2px solid #FFD700;
      cursor: pointer;
      z-index: 50;
      display: none; /* Hidden by default, shown when game starts */
    }
    #pauseButton:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    /* Leaderboard Styles */
    .leaderboard-button {
      padding: 10px 15px;
      border: none;
      border-radius: 50px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-family: 'Press Start 2P', cursive;
      font-size: 0.7em;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      border: 2px solid #FFD700;
    }
    .leaderboard-button:hover {
      background: rgba(0,0,0,0.8);
      transform: translateY(-2px);
    }
    #leaderboard {
      margin-top: 10px;
      background: rgba(0,0,0,0.6);
      padding: 15px;
      border-radius: 15px;
      border: 2px solid #FFD700;
      max-height: 200px;
      overflow-y: auto;
      color: #fff;
      font-size: 0.8em;
      text-align: left;
      transition: all 0.3s ease;
    }
    .leaderboard-hidden {
      max-height: 0;
      padding: 0 15px;
      margin: 0;
      border: 0;
      overflow: hidden;
      opacity: 0;
    }
    #leaderboard h3 {
      color: #FFD700;
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }
    #leaderboard ol {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #leaderboard li {
      padding: 5px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.3);
      display: flex;
      justify-content: space-between;
    }
    #leaderboard li:last-child {
      border-bottom: none;
    }
    #leaderboard li span:first-child {
      color: #ADD8E6;
    }
    #leaderboard li span:last-child {
      color: #FFD700;
    }

    /* Creator text styling */
    #creatorText {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 500px;
      text-align: center;
      font-size: 0.7em;
      padding: 10px;
      background: rgba(0,0,0,0.85);
      color: #FFD700;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      border: 2px solid rgba(255,215,0,0.3);
      border-radius: 12px;
      z-index: 100;
      opacity: 0.8;
    }

    /* Game Logo */
    #gameLogo {
      width: 150px;
      height: auto;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 10px rgba(255,215,0,0.8));
    }

    /* Power-up styles */
    .power-up {
      position: absolute;
      width: 30px;
      height: 30px;
      background-color: gold; /* Example color */
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2em;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 5px black;
      box-shadow: 0 0 10px gold;
      z-index: 3;
      animation: pulse 1s infinite;
    }
    .power-up.jump-boost {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      box-shadow: 0 0 15px #FFD700;
      font-size: 1.5em;
      line-height: 1;
    }

    /* Particle effect */
    .particle {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: particle-fade 0.8s forwards;
      pointer-events: none;
      z-index: 4;
    }

    /* Audio control buttons */
    .audio-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 101;
    }

    .audio-control-button {
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: 2px solid #FFD700;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2em;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .audio-control-button:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    /* Theme popup */
    .theme-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      background: #2196F3; /* Default color, overridden by JS */
      color: white;
      border-radius: 50px;
      font-family: 'Press Start 2P', cursive;
      font-size: 0.8em;
      z-index: 1000;
      box-shadow: 0 0 20px rgba(255,255,255,0.7);
      animation: pulse 1s 2;
      opacity: 1;
      transition: all 0.5s ease-out;
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
        #startScreen, #gameOverScreen, #pauseScreen {
            padding: 15px 15px 50px;
            font-size: 16px;
            width: 90%; /* Adjust width for smaller screens */
        }
        #gameOverScreen {
            padding-top: 60px;
        }
        #startScreen h1, #gameOverScreen h2, #pauseScreen h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        .character-options {
            flex-direction: row; /* Ubah menjadi row untuk 768px ke bawah */
            justify-content: center; /* Pusatkan lagi */
            gap: 15px;
        }
        .character-card {
            flex-basis: auto; /* Biarkan browser menentukan lebar berdasarkan konten */
            max-width: 150px; /* Batasi lebar agar tidak terlalu besar */
            padding: 15px;
        }
        .character-image {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }
        .character-button, .game-over-button, .pause-button {
            padding: 10px 15px;
            font-size: 0.7em;
        }
        #finalScore {
            font-size: 1em;
            margin-bottom: 15px;
        }
        #highScoreDisplay {
            font-size: 0.9em;
            margin-top: 8px;
        }
        #scoreDisplay {
            font-size: 0.7em;
            padding: 6px 10px;
            gap: 5px;
        }
        #scoreDisplay img {
            width: 16px;
            height: 16px;
        }
        #livesDisplay {
          padding: 6px 10px;
          gap: 3px;
        }
        .life-icon {
          width: 20px;
          height: 20px;
        }
        #pauseButton {
          padding: 6px 10px;
          font-size: 0.7em;
        }
        #coinMilestonePopup {
            width: 150px;
        }
        #creatorText {
            font-size: 0.6em;
            padding: 8px;
            bottom: 10px;
        }
        #gameLogo {
            width: 120px;
        }
        #leaderboard {
          font-size: 0.7em;
          padding: 10px;
        }
        .audio-control-button {
          width: 35px;
          height: 35px;
          font-size: 1em;
        }
        .audio-controls {
          bottom: 10px;
          right: 10px;
        }
    }

    @media (max-width: 480px) {
        #startScreen, #gameOverScreen, #pauseScreen {
            padding: 10px 10px 40px;
            font-size: 14px;
        }
        #gameOverScreen {
            padding-top: 50px;
        }
        #startScreen h1, #gameOverScreen h2, #pauseScreen h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .game-over-header {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin-bottom: 15px;
        }
        .game-over-header h2 {
          font-size: 1.1em;
        }
          .game-over-icon {
          width: 2em;
          height: 2em;
          border-radius: 50%;
          object-fit: cover;
          border: 2px solid white;
          box-shadow: 0 0 6px rgba(255, 255, 255, 0.4);
          animation: float 3s ease-in-out infinite;
        }
        .character-options {
            flex-direction: row; /* Tetap row untuk 480px ke bawah */
            justify-content: center; /* Pusatkan lagi */
            gap: 10px;
        }
        .character-card {
            padding: 10px;
            max-width: 120px; /* Lebih kecil untuk layar sangat kecil */
        }
        .character-image {
            width: 70px;
            height: 70px;
            margin-bottom: 8px;
        }
        .character-button, .game-over-button, .pause-button {
            padding: 8px 12px;
            font-size: 0.6em;
        }
        #finalScore {
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        #highScoreDisplay {
            font-size: 0.8em;
            margin-top: 6px;
        }
        #scoreDisplay {
            font-size: 0.6em;
            padding: 5px 8px;
            gap: 3px;
        }
        #scoreDisplay img {
            width: 14px;
            height: 14px;
        }
        #livesDisplay {
          padding: 5px 8px;
          gap: 2px;
        }
        .life-icon {
          width: 18px;
          height: 18px;
        }
        #pauseButton {
          padding: 5px 8px;
          font-size: 0.6em;
        }
        #coinMilestonePopup {
            width: 120px;
        }
        #creatorText {
            font-size: 0.55em;
            padding: 6px;
            bottom: 8px;
        }
        #gameLogo {
            width: 100px;
        }
        #leaderboard {
          font-size: 0.6em;
          padding: 8px;
        }
    }
  </style>
</head>
<body>
  <div id="loadingScreen">Memuat Aset...</div>  

  <!-- Audio Elements -->
  <audio id="jumpSound" src="jump.mp3" preload="auto"></audio>
  <audio id="coinSound" src="coin.mp3" preload="auto"></audio>
  <audio id="gameOverSound" src="gameover.mp3" preload="auto"></audio>
  <audio id="powerupSound" src="powerup.mp3" preload="auto"></audio>
  <audio id="damageSound" src="damage.mp3" preload="auto"></audio>
  <audio id="buttonSound" src="click.mp3" preload="auto"></audio>
  <audio id="bgm" src="bgm.mp3" preload="auto" loop></audio>
  <audio id="menuBgm" src="menu.mp3" preload="auto" loop></audio>

  <!-- Main Game Container -->
  <div id="startScreen">
    <img id="gameLogo" src="popup.jpg" alt="Skybound Lovers Logo">
    <h1>Skybound Lovers</h1>
    <div id="mainMenu">
      <button class="main-button" onclick="showCharacterSelect()">Mulai Game</button>
      <div id="characterPreview" style="margin: 20px auto; display: none;">
        <h3>Karakter Terpilih:</h3>
        <img id="selectedCharacterImg" src="" alt="Karakter Terpilih" 
             style="width: 100px; height:100px; border-radius:50%; border:3px solid gold">
      </div>
      <button class="leaderboard-button" onclick="toggleLeaderboard()">‚¨Ü Lihat Leaderboard</button>
      <div id="leaderboard" class="leaderboard-hidden">
        <h3>Leaderboard</h3>
        <ol id="leaderboardList"><li>Belum ada skor.</li></ol>
      </div>
    </div>
    
    <div id="characterSelect" style="display: none;">
      <h2>Pilih Karakter</h2>
      <div class="character-options">
        <div class="character-card" data-character-id="1">
          <img src="laki-laki copy.png" alt="Karakter Laki-laki" class="character-image">
          <p>Laki-laki</p>
        </div>
        <div class="character-card" data-character-id="2">
          <img src="perempuan copyy.png" alt="Karakter Perempuan" class="character-image">
          <p>Perempuan</p>
        </div>
      </div>
      <button class="main-button" id="startGameButton" style="display: none;">Mulai Game!</button>
      <button class="back-button" onclick="backToMain()">‚¨Ö Kembali</button>
    </div>
  </div>

  <p id="creatorText">
    CREATED BY RAFA STUDIOS 
    <br>¬© 2025 - ALL RIGHTS RESERVED
  </p>

  <canvas id="gameCanvas" width="400" height="600"></canvas>

  <!-- Score and Coin Display -->
  <div id="scoreDisplay">
    Skor: <span id="currentScore">0</span>
    <img src="coin.png" alt="Koin" style="width: 20px; height: 20px;"> Love: <span id="currentCoinScore">0</span>
  </div>

  <!-- Lives Display -->
  <div id="livesDisplay">
    <img src="heart.png" alt="Life" class="life-icon">
    <img src="heart.png" alt="Life" class="life-icon">
    <img src="heart.png" alt="Life" class="life-icon">
  </div>

  <!-- Pause Button -->
  <button id="pauseButton" onclick="togglePause()">||</button>

  <div id="gameOverScreen">
    <div class="game-over-header">
      <img src="ana.jpg" alt="Decor" class="game-over-icon">
      <h2>Game Over!</h2>
      <img src="farel.jpg" alt="Decor" class="game-over-icon">
    </div>
  
    <p id="finalScore">Skor Akhir: 0</p>
    <p id="highScoreDisplay"></p>
  
    <div class="button-group">
      <button class="game-over-button" onclick="restartGame()">Main Lagi!</button>
      <button class="back-button" onclick="showStartMenu()">Kembali ke Menu</button>
    </div>
  </div>
  
  <!-- Pause Screen -->
  <div id="pauseScreen">
    <h2>Game Dijeda</h2>
    <div class="button-group">
      <button class="pause-button" onclick="togglePause()">Lanjut</button>
      <button class="back-button" onclick="showStartMenu()">Kembali ke Menu</button>
    </div>
  </div>

  <!-- Coin Milestone Popup -->
  <img id="coinMilestonePopup" src="popup.jpg" alt="Milestone Koin">

  <!-- Audio Control Buttons -->
  <div class="audio-controls">
    <button id="bgmControl" class="audio-control-button" aria-label="Toggle Background Music">üéµ</button>
    <button id="sfxControl" class="audio-control-button" aria-label="Toggle Sound Effects">üîä</button>
  </div>

  <script defer>
    // DOM Elements
    const loadingScreen = document.getElementById("loadingScreen");
    const jumpSound = document.getElementById("jumpSound");
    const coinSound = document.getElementById("coinSound");
    const gameOverSound = document.getElementById("gameOverSound");
    const powerupSound = document.getElementById("powerupSound");
    const damageSound = document.getElementById("damageSound");
    const buttonSound = document.getElementById("buttonSound");
    const bgm = document.getElementById("bgm");
    const menuBgm = document.getElementById("menuBgm");
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startScreen = document.getElementById("startScreen");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const pauseScreen = document.getElementById("pauseScreen");
    const coinMilestonePopup = document.getElementById("coinMilestonePopup");
    const currentScoreDisplay = document.getElementById("currentScore");
    const currentCoinScoreDisplay = document.getElementById("currentCoinScore");
    const highScoreDisplay = document.getElementById('highScoreDisplay');
    const canvasElement = document.getElementById('gameCanvas');
    const livesDisplay = document.getElementById('livesDisplay');
    const pauseButton = document.getElementById('pauseButton');
    const leaderboardList = document.getElementById('leaderboardList');
    const characterCards = document.querySelectorAll('.character-card');
    const selectedCharacterImg = document.getElementById('selectedCharacterImg');
    const startGameButton = document.getElementById('startGameButton');
    const bgmControl = document.getElementById('bgmControl');
    const sfxControl = document.getElementById('sfxControl');

    // Game State Variables
    let selectedCharacter = null; // Store the ID of the selected character
    const player = {
      x: 180,
      y: 500,
      width: 50,
      height: 50,
      dy: 0,
      jumpPower: -12,
      gravity: 0.5,
      speed: 0,
      maxSpeed: 5,
      image: new Image(),
      jumps: 0, // For double jump
      maxJumps: 2, // For double jump
      isFalling: false // To track if player is falling
    };

    const platforms = [];
    const platformCount = 10;
    let score = 0;
    let lastSafePosition = { x: player.x, y: player.y };
    let coinScore = 0;
    let gameStarted = false;
    let isPaused = false;
    let lastMilestone = 0;
    let highScore = localStorage.getItem('highScore') ? parseInt(localStorage.getItem('highScore')) : 0;
    let lives = 3;
    let animationFrameId; // To store requestAnimationFrame ID
    let isBgmMuted = localStorage.getItem('isBgmMuted') === 'true'; // Load BGM mute state
    let isSfxMuted = localStorage.getItem('isSfxMuted') === 'true'; // Load SFX mute state

    const coins = [];
    const coinImage = new Image();
    coinImage.src = "coin.png";

    const powerUps = [];
    const powerUpImage = new Image();
    powerUpImage.src = "powerup.png"; // Placeholder for a jump power-up image

    let platformSpeedMultiplier = 1; // For level progression
    let jumpBoostActive = false;
    let originalJumpPower = player.jumpPower;

    // Asset Paths
    const imageAssets = [
      'popup.jpg',
      'laki-laki copy.png',
      'ChatGPT Image 15 Jul 2025 15.43.23.png',
      'perempuan copyy.png',
      'ChatGPT_Image_15_Jul_2025_15.20.27-removebg-preview.png',
      'coin.png',
      'heart.png',
      'ana.jpg',
      'farel.jpg',
      'powerup.png',
      'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/504ea317-e0a0-4a72-a92a-ccdcfcbc6893.png', // Buildings theme
      'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/ed8cb5e3-2b89-47bb-9c86-80d2a449f7a3.png', // Birds theme
      'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/8f111458-08a8-45c6-afbb-5de16e209a41.png' // Space theme
    ];

    const audioAssets = [
      'jump.mp3',
      'coin.mp3',
      'gameover.mp3',
      'powerup.mp3',
      'damage.mp3',
      'click.mp3',
      'bgm.mp3',
      'menu.mp3'
    ];

    /**
     * Preloads all specified image and audio assets.
     * Displays a loading screen until all assets are loaded.
     */
    async function preloadAssets() {
      const imagePromises = imageAssets.map(src => {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.src = src;
          img.onload = () => resolve();
          img.onerror = () => {
            console.warn(`Failed to load image: ${src}`);
            resolve(); // Resolve even on error to not block loading
          };
        });
      });

      const audioPromises = audioAssets.map(src => {
        return new Promise((resolve, reject) => {
          const audio = new Audio();
          audio.src = src;
          audio.oncanplaythrough = () => resolve();
          audio.onerror = () => {
            console.warn(`Failed to load audio: ${src}`);
            resolve(); // Resolve even on error
          };
          audio.load(); // Start loading the audio
        });
      });

      await Promise.all([...imagePromises, ...audioPromises]);
      loadingScreen.style.display = "none";
    }

    /**
     * Plays an audio element, handling potential Promise rejections.
     * @param {HTMLAudioElement} audioElement - The audio element to play.
     * @param {string} type - 'sfx' or 'bgm'
     */
    function playSound(audioElement, type) {
      if (type === 'sfx' && isSfxMuted) return;
      if (type === 'bgm' && isBgmMuted) return;

      if (audioElement) {
        audioElement.currentTime = 0; // Reset to start
        audioElement.play().catch(error => {
          console.warn("Autoplay prevented:", error);
        });
      }
    }

    /**
     * Toggles the mute state of BGM.
     */
    function toggleBgmMute() {
      isBgmMuted = !isBgmMuted;
      localStorage.setItem('isBgmMuted', isBgmMuted);
      if (isBgmMuted) {
        menuBgm.pause();
        bgm.pause();
        bgmControl.textContent = 'üîá';
      } else {
        if (gameStarted) {
          playSound(bgm, 'bgm');
        } else {
          playSound(menuBgm, 'bgm');
        }
        bgmControl.textContent = 'üéµ';
      }
    }

    /**
     * Toggles the mute state of SFX.
     */
    function toggleSfxMute() {
      isSfxMuted = !isSfxMuted;
      localStorage.setItem('isSfxMuted', isSfxMuted);
      const sfxElements = [jumpSound, coinSound, gameOverSound, powerupSound, damageSound, buttonSound];
      sfxElements.forEach(audio => {
        audio.muted = isSfxMuted;
      });
      sfxControl.textContent = isSfxMuted ? 'üîï' : 'üîä';
    }

    // Event listener for all buttons to play click sound
    document.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        playSound(buttonSound, 'sfx');
      });
    });

    // Function to draw the player (using canvas for player)
    function drawPlayer() {
      if (player.image.src && player.image.complete) {
        ctx.drawImage(player.image, player.x, player.y, player.width, player.height);
      } else {
        // Fallback if image fails to load
        ctx.fillStyle = 'blue';
        ctx.fillRect(player.x, player.y, player.width, player.height);
      }
    }

    // Function to draw coins (using canvas for coins)
    function drawCoins() {
      coins.forEach(coin => {
        if (!coin.taken) {
          ctx.drawImage(coinImage, coin.x, coin.y, coin.width, coin.height);
        }
      });
    }

    // Function to draw power-ups (using canvas for power-ups)
    function drawPowerUps() {
      powerUps.forEach(pu => {
        if (!pu.taken) {
          ctx.drawImage(powerUpImage, pu.x, pu.y, pu.width, pu.height);
        }
      });
    }

    // Function to create coins (called when a new platform appears)
    function createCoinOnPlatform(platform) {
      if (platform.type !== "obstacle" && Math.random() < 0.9) { // 90% chance
        const coinCount = Math.min(Math.floor(platform.width / 40), 3); // Max 3 coins based on platform width
        const spacing = platform.width / (coinCount + 1);
        for (let i = 1; i <= coinCount; i++) {
          coins.push({
            x: platform.x + (spacing * i) - 15,
            y: platform.y - 30,
            width: 30,
            height: 30,
            taken: false
          });
        }
      }
    }

    // Function to create power-up
    function createPowerUp(platform) {
      powerUps.push({
        x: platform.x + platform.width / 2 - 15,
        y: platform.y - 40,
        width: 30,
        height: 30,
        type: 'jump-boost',
        taken: false
      });
    }

    // Function to initialize platforms (create DOM elements once)
    function initializePlatforms() {
      // Clear existing platforms from array and DOM
      platforms.forEach(p => {
        if (p.element) p.element.remove();
      });
      platforms.length = 0;

      // Initial stable platform
      const initialPlatform = {
        x: 0,
        y: 570,
        width: 400,
        height: 10,
        color: "#ffffff",
        type: "static",
        element: null,
        disappearing: false,
        touched: false
      };
      platforms.push(initialPlatform);
      createPlatformElement(initialPlatform);

      // Create other platforms
      for (let i = 0; i < platformCount; i++) {
        const newPlatform = {
          x: Math.random() * (canvas.width - 60), // Default width
          y: 600 - (i + 1) * 60,
          width: 60,
          height: 10,
          color: "#ffffff",
          type: "static",
          element: null,
          disappearing: false,
          touched: false
        };
        platforms.push(newPlatform);
        createPlatformElement(newPlatform);
      }
    }

    // Helper to create a single platform DOM element
    function createPlatformElement(p) {
      const platformElement = document.createElement('div');
      platformElement.className = 'game-platform platform-cloud';
      platformElement.style.position = 'absolute';
      platformElement.style.width = `${p.width}px`;
      platformElement.style.height = `${p.height}px`;
      platformElement.style.backgroundColor = p.color;
      p.element = platformElement;
      document.body.appendChild(platformElement);
      updatePlatformElementPosition(p); // Set initial position
    }

    // Helper to update platform DOM element position
    function updatePlatformElementPosition(p) {
      if (p.element) {
        const canvasRect = canvas.getBoundingClientRect();
        p.element.style.left = `${canvasRect.left + p.x}px`;
        p.element.style.top = `${canvasRect.top + p.y}px`;
      }
    }

    // Function to move platforms and update their DOM positions
    function movePlatforms(dy) {
      platforms.forEach(p => {
        p.y += dy * platformSpeedMultiplier;

        if (p.y > canvas.height) { // If platform goes off screen
          // Reset platform to top
          p.y = -p.height;
          p.x = Math.random() * (canvas.width - p.width);
          score++;

          // Re-determine platform type randomly
          const randomType = Math.random();
          
          // Reset classes and properties
          if (p.element) {
            p.element.classList.remove("platform-moving-horizontal", "platform-moving-vertical", "platform-small-obstacle", "platform-disappearing");
            p.element.style.opacity = 1; // Reset opacity for disappearing platforms
          }
          p.disappearing = false;
          p.touched = false;

          if (randomType < 0.2) {
            p.type = "horizontal";
            p.width = 80;
            p.height = 10;
            if (p.element) p.element.classList.add("platform-moving-horizontal");
          } else if (randomType < 0.4) {
            p.type = "vertical";
            p.width = 70;
            p.height = 10;
            if (p.element) p.element.classList.add("platform-moving-vertical");
          } else if (randomType < 0.5) {
            p.type = "obstacle";
            p.width = 40;
            p.height = 40;
            if (p.element) p.element.classList.add("platform-small-obstacle");
            p.y -= 20; // Position slightly higher for obstacle
          } else if (score >= 100 && randomType < 0.6) { // Disappearing platforms after score 100
            p.type = "static";
            p.width = 60;
            p.height = 10;
            p.disappearing = true;
            if (p.element) p.element.classList.add("platform-disappearing");
          } else {
            p.type = "static";
            p.width = 60;
            p.height = 10;
          }
          // Update DOM element dimensions
          if (p.element) {
            p.element.style.width = `${p.width}px`;
            p.element.style.height = `${p.height}px`;
          }

          createCoinOnPlatform(p); // Add coins to new platform

          // Add power-up every 20 coins
          if (coinScore > 0 && coinScore % 20 === 0) {
            createPowerUp(p);
          }
        }
        updatePlatformElementPosition(p); // Update DOM position for all platforms
      });

      // Move and remove coins that go off screen
      for (let i = coins.length - 1; i >= 0; i--) {
        coins[i].y += dy * platformSpeedMultiplier;
        if (coins[i].y > canvas.height) {
          coins.splice(i, 1);
        }
      }

      // Move and remove power-ups that go off screen
      for (let i = powerUps.length - 1; i >= 0; i--) {
        powerUps[i].y += dy * platformSpeedMultiplier;
        if (powerUps[i].y > canvas.height) {
          powerUps.splice(i, 1);
        }
      }
    }

    // Function to check player-platform collision
    function checkPlatformCollision() {
      let onPlatform = false;
      platforms.forEach(p => {
        if (!p.element) return; // Skip if DOM element not yet created

        // Get actual position of the platform from its DOM element
        const platformRect = p.element.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();

        // Convert platform position to canvas coordinates
        const pX = platformRect.left - canvasRect.left;
        const pY = platformRect.top - canvasRect.top;
        const pWidth = platformRect.width;
        const pHeight = platformRect.height;

        // Collision detection logic
        if (
          player.dy > 0 && // Player is falling
          player.x + player.width > pX &&
          player.x < pX + pWidth &&
          player.y + player.height > pY &&
          player.y + player.height < pY + pHeight + player.dy // Player lands on top of platform
        ) {
          player.dy = player.jumpPower; // Make player jump
          player.y = pY - player.height; // Snap player to top of platform
          player.jumps = 0; // Reset double jump
          lastSafePosition = { x: player.x, y: player.y };
          onPlatform = true;

          // Particle effect on landing
          createParticles(player.x + player.width / 2, player.y + player.height);

          // Handle disappearing platforms
          if (p.disappearing && !p.touched) {
            p.touched = true;
            setTimeout(() => {
              if (p.element) p.element.style.opacity = 0; // Make it disappear
            }, 200); // Disappear after 200ms
          }
        }
      });
      player.isFalling = !onPlatform && player.dy > 0; // Update isFalling status
    }

    // Function to check player-coin collision
    function checkCoinCollision() {
      for (let i = coins.length - 1; i >= 0; i--) {
        const coin = coins[i];
        if (!coin.taken) {
          if (
            player.x < coin.x + coin.width &&
            player.x + player.width > coin.x &&
            player.y < coin.y + coin.height &&
            player.y + player.height > coin.y
          ) {
            coin.taken = true;
            coinScore++;
            coins.splice(i, 1); // Remove collected coin
            playSound(coinSound, 'sfx');
          }
        }
      }
    }

    // Function to check player-power-up collision
    function checkPowerUpCollision() {
      for (let i = powerUps.length - 1; i >= 0; i--) {
        const pu = powerUps[i];
        if (!pu.taken) {
          if (
            player.x < pu.x + pu.width &&
            player.x + player.width > pu.x &&
            player.y < pu.y + pu.height &&
            player.y + player.height > pu.y
          ) {
            pu.taken = true;
            powerUps.splice(i, 1); // Remove collected power-up
            activatePowerUp(pu.type);
          }
        }
      }
    }

    // Activate power-up effect
    function activatePowerUp(type) {
      playSound(powerupSound, 'sfx');
      if (type === 'jump-boost') {
        if (!jumpBoostActive) {
          player.jumpPower *= 1.5; // Increase jump power
          jumpBoostActive = true;
          setTimeout(() => {
            player.jumpPower = originalJumpPower; // Reset jump power
            jumpBoostActive = false;
          }, 5000); // Lasts for 5 seconds
        }
      }
    }

    // Create particle effect
    function createParticles(x, y) {
      const numParticles = 5 + Math.floor(Math.random() * 5);
      for (let i = 0; i < numParticles; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const size = Math.random() * 5 + 2; // 2-7px
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        const canvasRect = canvas.getBoundingClientRect();
        particle.style.left = `${canvasRect.left + x + (Math.random() * 10 - 5)}px`;
        particle.style.top = `${canvasRect.top + y + (Math.random() * 10 - 5)}px`;
        
        document.body.appendChild(particle);
        
        // Remove particle after animation
        particle.addEventListener('animationend', () => {
          particle.remove();
        });
      }
    }

    // Main game update loop
    function update() {
      if (!gameStarted || isPaused) {
        animationFrameId = requestAnimationFrame(update); // Keep requesting frame even if paused to handle resume
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

      player.y += player.dy;
      player.dy += player.gravity;

      player.x += player.speed;

      // Keep player within canvas bounds
      if (player.x < 0) player.x = 0;
      if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

      // Move platforms down if player is high enough
      if (player.y < canvas.height / 2) {
        const offset = canvas.height / 2 - player.y;
        player.y = canvas.height / 2;        // tetap jaga dia di tengah
        movePlatforms(offset);               // geser platform sesuai selisih aslinya
      }

      // Check if player falls off screen
      if (player.y > canvas.height) {
        lives--;
        updateLivesDisplay();
        playSound(damageSound, 'sfx');
        if (lives <= 0) {
          endGame();
          return; // Stop update loop
        } else {
          player.x = lastSafePosition.x;
          player.y = lastSafePosition.y;
          player.dy = 0;
          player.speed = 0;
          player.jumps = 0;

          // Visual effect on respawn
          createParticles(player.x + player.width / 2, player.y + player.height / 2);
        }
      }

      checkPlatformCollision();
      checkCoinCollision();
      checkPowerUpCollision();

      // Coin milestone popup
      const currentMilestone = Math.floor(coinScore / 10) * 10;
      if (currentMilestone > 0 && currentMilestone > lastMilestone) {
        lastMilestone = currentMilestone;
        
        coinMilestonePopup.style.display = 'block';
        setTimeout(() => {
          coinMilestonePopup.style.opacity = 1;
        }, 50);

        setTimeout(() => {
          coinMilestonePopup.style.opacity = 0;
          setTimeout(() => {
            coinMilestonePopup.style.display = 'none';
          }, 500);
        }, 2000);
      }

      // Level progression: increase platform speed
      platformSpeedMultiplier = 1 + Math.floor(score / 50) * 0.1; // Increase speed every 50 score

      // Theme switching
      let newThemeClass = 'theme-buildings';
      if (score > 0) {
        const themeCycle = Math.floor((score - 1) / 50) % 3;
        if (themeCycle === 1) {
          newThemeClass = 'theme-birds';
        } else if (themeCycle === 2) {
          newThemeClass = 'theme-space';
        }
      }

      if (!canvasElement.classList.contains(newThemeClass)) {
        canvasElement.classList.add('no-transition');
        canvasElement.className = ''; // Clear all existing theme classes
        
        setTimeout(() => {
          canvasElement.classList.remove('no-transition');
          if (newThemeClass) {
            canvasElement.classList.add(newThemeClass);
            
            if (newThemeClass === 'theme-birds') {
              showThemePopup("ü¶Ö Birds Theme", "#9C27B0");
            } else if (newThemeClass === 'theme-space') {
              showThemePopup("üåü Space Theme", "#6a0dad");
            }
          }
        }, 10);
      }

      drawPlayer();
      drawCoins();
      drawPowerUps();
      updateScoreDisplay();
      animationFrameId = requestAnimationFrame(update);
    }

    // End game function
    function endGame() {
      gameStarted = false;
      cancelAnimationFrame(animationFrameId); // Stop the game loop
      document.getElementById('finalScore').textContent = 'Skor Akhir: ' + score;

      updateLeaderboard(score); // Update leaderboard

      if (score > highScore) {
        highScore = score;
        localStorage.setItem('highScore', highScore);
        highScoreDisplay.textContent = 'üéâ HIGH SCORE BARU! ' + highScore + ' üéâ';
        highScoreDisplay.classList.add('new-highscore');
      } else {
        highScoreDisplay.textContent = '‚≠ê SKOR TERTINGGI: ' + highScore + ' ‚≠ê';
        highScoreDisplay.classList.remove('new-highscore');
      }

      document.getElementById('scoreDisplay').style.display = 'none';
      livesDisplay.style.display = 'none';
      pauseButton.style.display = 'none';
      document.querySelector('.audio-controls').style.display = 'flex'; // Tampilkan tombol mute saat game berakhir
      playSound(gameOverSound, 'sfx');
      gameOverScreen.style.display = 'block';
      setTimeout(() => {
          gameOverScreen.classList.add('show');
      }, 50);
      playSound(menuBgm, 'bgm');
      bgm.pause();
    }

    // Update score and coin display
    function updateScoreDisplay() {
      currentScoreDisplay.textContent = score;
      currentCoinScoreDisplay.textContent = coinScore;
    }

    // Update lives display
    function updateLivesDisplay() {
      const lifeIcons = livesDisplay.children;
      for (let i = 0; i < lifeIcons.length; i++) {
        if (i < lives) {
          lifeIcons[i].style.opacity = 1;
        } else {
          lifeIcons[i].style.opacity = 0.3; // Dim lost lives
        }
      }
    }

    // Keyboard controls
    document.addEventListener("keydown", e => {
      if (isPaused || !gameStarted) return;
      if (e.key === "ArrowLeft") {
        player.speed = -player.maxSpeed;
      } else if (e.key === "ArrowRight") {
        player.speed = player.maxSpeed;
      } else if (e.key === "ArrowUp" || e.key === " ") { // Double jump
        if (player.jumps < player.maxJumps) {
          player.dy = player.jumpPower;
          player.jumps++;
          createParticles(player.x + player.width/2, player.y + player.height);
          playSound(jumpSound, 'sfx');
        }
      }
    });

    document.addEventListener("keyup", e => {
      if (isPaused || !gameStarted) return;
      if (e.key === "ArrowLeft" || e.key === "ArrowRight") {
        player.speed = 0;
      }
    });

    // Touch controls
    let touchStartX = 0;
    let touchStartY = 0;
    canvas.addEventListener('touchstart', (e) => {
        if (isPaused || !gameStarted) return;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        e.preventDefault(); // Prevent scrolling
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        if (isPaused || !gameStarted) return;
        const touchCurrentX = e.touches[0].clientX;
        const diffX = touchCurrentX - touchStartX;

        if (Math.abs(diffX) > 10) {
            if (diffX > 0) {
                player.speed = player.maxSpeed;
            } else {
                player.speed = -player.maxSpeed;
            }
        }
        e.preventDefault(); // Prevent scrolling
    }, { passive: false });

    canvas.addEventListener('touchend', (e) => {
        if (isPaused || !gameStarted) return;
        player.speed = 0;
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const diffY = touchStartY - touchEndY;

        // Simple tap for jump (if not a horizontal swipe)
        if (Math.abs(touchEndX - touchStartX) < 20 && diffY > 20) { // Detect upward swipe for jump
          if (player.jumps < player.maxJumps) {
            player.dy = player.jumpPower;
            player.jumps++;
            createParticles(player.x + player.width/2, player.y + player.height);
            playSound(jumpSound, 'sfx');
          }
        }
    });

    // Start game function
    function startGame() {
      if (!selectedCharacter) {
        alert("Silakan pilih karakter terlebih dahulu!");
        return;
      }

      playSound(bgm, 'bgm');
      menuBgm.pause();

      startScreen.classList.remove('show');
      setTimeout(() => {
        startScreen.style.display = "none";
      }, 500);

      document.getElementById('scoreDisplay').style.display = 'flex'; 
      livesDisplay.style.display = 'flex';
      pauseButton.style.display = 'block';
      document.querySelector('.audio-controls').style.display = 'none'; // Sembunyikan tombol mute saat game dimulai
      
      // Initialize game state
      score = 0;
      coinScore = 0;
      lastMilestone = 0;
      lives = 3;
      platformSpeedMultiplier = 1;
      player.jumpPower = originalJumpPower; // Reset jump power
      jumpBoostActive = false;

      // Reset platforms, coins, power-ups
      platforms.forEach(p => {
        if (p.element) p.element.remove(); // Remove all existing DOM elements
      });
      platforms.length = 0; // Clear the array
      coins.length = 0;
      powerUps.length = 0;
      
      player.y = 500; // Reset player position
      player.dy = 0;
      player.speed = 0;
      player.jumps = 0;

      initializePlatforms(); // Re-initialize platforms and their DOM elements
      updateLivesDisplay();

      // Reset canvas theme to default
      canvasElement.classList.add('no-transition');
      canvasElement.className = 'theme-buildings';
      setTimeout(() => {
        canvasElement.classList.remove('no-transition');
      }, 10);

      setTimeout(() => {
        gameStarted = true;
        isPaused = false;
        update(); // Start game loop
      }, 500);
    }

    // Toggle pause state
    function togglePause() {
      isPaused = !isPaused;
      if (isPaused) {
        cancelAnimationFrame(animationFrameId); // Stop the game loop
        pauseScreen.style.display = 'block';
        setTimeout(() => {
          pauseScreen.classList.add('show');
        }, 50);
        bgm.pause();
        document.querySelector('.audio-controls').style.display = 'flex'; // Tampilkan tombol mute saat game dijeda
      } else {
        pauseScreen.classList.remove('show');
        setTimeout(() => {
          pauseScreen.style.display = 'none';
          update(); // Resume game loop
        }, 500);
        playSound(bgm, 'bgm');
        document.querySelector('.audio-controls').style.display = 'none'; // Sembunyikan tombol mute saat game dilanjutkan
      }
    }

    // Show character selection screen
    function showCharacterSelect() {
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('characterSelect').style.display = 'block';
      // Reset selected character and hide start game button
      selectedCharacter = null;
      startGameButton.style.display = 'none';
      characterCards.forEach(card => card.classList.remove('selected'));
      selectedCharacterImg.src = ""; // Clear preview image
      document.getElementById('characterPreview').style.display = 'none';
    }

    // Back to main menu from character select or game over/pause screen
    function showStartMenu() {
      gameOverScreen.classList.remove('show');
      pauseScreen.classList.remove('show');
      setTimeout(() => {
        gameOverScreen.style.display = 'none';
        pauseScreen.style.display = 'none';
        startScreen.style.display = 'block';
        document.getElementById('mainMenu').style.display = 'block'; // Ensure main menu is visible
        document.getElementById('characterSelect').style.display = 'none'; // Hide character select
        setTimeout(() => {
          startScreen.classList.add('show');
        }, 50);
      }, 500);
      
      // Clear all platform DOM elements when returning to menu
      platforms.forEach(p => {
        if (p.element) p.element.remove();
      });
      platforms.length = 0; // Clear the array
      document.querySelectorAll('.power-up').forEach(el => el.remove()); // Remove power-up elements
      document.querySelectorAll('.particle').forEach(el => el.remove()); // Remove particle elements
      
      // Ensure game loop is stopped
      cancelAnimationFrame(animationFrameId);
      gameStarted = false;
      isPaused = false;
      document.getElementById('scoreDisplay').style.display = 'none';
      livesDisplay.style.display = 'none';
      pauseButton.style.display = 'none';
      document.querySelector('.audio-controls').style.display = 'flex'; // Tampilkan tombol mute saat kembali ke menu utama
      loadLeaderboard(); // Reload leaderboard when returning to main menu
      playSound(menuBgm, 'bgm');
      bgm.pause();
    }

    // Back to main menu from character select
    function backToMain() {
      document.getElementById('characterSelect').style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
      loadLeaderboard(); // Reload leaderboard when returning to main menu
    }

    // Character selection logic
    characterCards.forEach(card => {
      card.addEventListener('click', () => {
        characterCards.forEach(c => c.classList.remove('selected')); // Remove selected from all
        card.classList.add('selected'); // Add selected to clicked card
        selectedCharacter = parseInt(card.dataset.characterId);
        
        const charImageSrc = selectedCharacter === 1 ? "ChatGPT Image 15 Jul 2025 15.43.23.png" : "ChatGPT_Image_15_Jul_2025_15.20.27-removebg-preview.png";
        selectedCharacterImg.src = charImageSrc;
        document.getElementById('characterPreview').style.display = 'block';
        player.image.src = charImageSrc;
        startGameButton.style.display = 'block'; // Show the "Mulai Game!" button
      });
    });

    // Event listener for the "Mulai Game!" button in character select
    startGameButton.addEventListener('click', startGame);
    
    // Show theme change popup
    function showThemePopup(message, color) {
      const popup = document.createElement('div');
      popup.textContent = message;
      popup.classList.add('theme-popup');
      popup.style.background = color;
      
      document.body.appendChild(popup);
      
      setTimeout(() => {
        popup.style.opacity = '0';
        setTimeout(() => popup.remove(), 500);
      }, 1500);
    }

    // Restart game
    function restartGame() {
      gameOverScreen.classList.remove('show');
      setTimeout(() => {
        gameOverScreen.style.display = 'none';
      }, 500);

      // Clear all platform DOM elements before restarting
      platforms.forEach(p => {
        if (p.element) p.element.remove();
      });
      platforms.length = 0; // Clear the array
      document.querySelectorAll('.power-up').forEach(el => el.remove()); // Remove power-up elements
      document.querySelectorAll('.particle').forEach(el => el.remove()); // Remove particle elements

      startGame(); // Re-initialize and start game
    }

    // Leaderboard functions
    function getLeaderboard() {
      const leaderboard = localStorage.getItem('leaderboard');
      return leaderboard ? JSON.parse(leaderboard) : [];
    }

    function saveLeaderboard(leaderboard) {
      localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
    }

    function updateLeaderboard(newScore) {
      let leaderboard = getLeaderboard();
      leaderboard.push({ score: newScore, date: new Date().toLocaleString() });
      leaderboard.sort((a, b) => b.score - a.score); // Sort descending
      leaderboard = leaderboard.slice(0, 5); // Keep top 5 scores
      saveLeaderboard(leaderboard);
      displayLeaderboard();
    }

    function displayLeaderboard() {
      const leaderboard = getLeaderboard();
      leaderboardList.innerHTML = '';
      if (leaderboard.length === 0) {
        leaderboardList.innerHTML = '<li>Belum ada skor.</li>';
        return;
      }
      leaderboard.forEach((entry, index) => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `<span>${index + 1}. ${entry.score}</span><span>${entry.date}</span>`;
        leaderboardList.appendChild(listItem);
      });
    }

    function loadLeaderboard() {
      displayLeaderboard();
    }
    
    function toggleLeaderboard() {
      const leaderboard = document.getElementById('leaderboard');
      const button = document.querySelector('.leaderboard-button');
      if (leaderboard.classList.contains('leaderboard-hidden')) {
        leaderboard.classList.remove('leaderboard-hidden');
        button.textContent = '‚¨á Tutup Leaderboard';
      } else {
        leaderboard.classList.add('leaderboard-hidden');
        button.textContent = '‚¨Ü Lihat Leaderboard';
      }
    }

    // Initial setup when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      // Preload assets first
      await preloadAssets();

      document.getElementById('scoreDisplay').style.display = 'none'; 
      livesDisplay.style.display = 'none';
      pauseButton.style.display = 'none';
      
      startScreen.style.display = "block";
      setTimeout(() => {
          startScreen.classList.add('show');
      }, 50);

      if (highScore > 0) {
          highScoreDisplay.textContent = '‚≠ê SKOR TERTINGGI: ' + highScore + ' ‚≠ê';
      } else {
          highScoreDisplay.textContent = '';
      }

      // Set initial canvas theme
      canvasElement.classList.add('theme-buildings');

      // Load leaderboard on startup
      loadLeaderboard();

      // Set initial audio control icons and states
      bgmControl.textContent = isBgmMuted ? 'üîá' : 'üéµ';
      sfxControl.textContent = isSfxMuted ? 'üîï' : 'üîä';
      bgmControl.addEventListener('click', toggleBgmMute);
      sfxControl.addEventListener('click', toggleSfxMute);
      
      // Apply initial mute states to audio elements
      bgm.muted = isBgmMuted;
      menuBgm.muted = isBgmMuted;
      jumpSound.muted = isSfxMuted;
      coinSound.muted = isSfxMuted;
      gameOverSound.muted = isSfxMuted;
      powerupSound.muted = isSfxMuted;
      damageSound.muted = isSfxMuted;
      buttonSound.muted = isSfxMuted;

      // Try to play menu BGM after user interaction (e.g., after loading screen disappears)
      document.addEventListener('click', () => {
        if (!isBgmMuted && menuBgm.paused) {
          playSound(menuBgm, 'bgm');
        }
      }, { once: true });
    });

    // Service Worker registration for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log("Service Worker terdaftar"))
        .catch(err => console.error("Service Worker gagal:", err));
    }
  </script>
</body>
</html>
