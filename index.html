<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Skybound Lovers</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    /* General Styles */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(to top, #a0d8f1, #e0f7ff); /* Default theme */
      font-family: 'Press Start 2P', cursive;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      height: 100%;
      transition: all 0.5s ease-in-out;
      -webkit-tap-highlight-color: transparent;
    }

    .no-transition {
      transition: none !important;
    }

    canvas {
      display: block;
      margin: 0 auto;
      background-color: #b3e5fc; /* Default canvas background */
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
      height: 600px;
      transition: background-color 0.5s ease-in-out;
      touch-action: none;
      position: relative;
      z-index: 1;
    }

    /* Parallax background layers for canvas */
    canvas::before, canvas::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      transition: all 1.5s cubic-bezier(0.215, 0.61, 0.355, 1);
      z-index: -1;
      background-size: cover;
      background-position: center;
    }

    /* Theme 1: Buildings */
    canvas.theme-buildings {
      background: linear-gradient(to top, #87CEEB, #ADD8E6);
      box-shadow: inset 0 0 100px rgba(135, 206, 235, 0.6);
    }
    canvas.theme-buildings::before {
      background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/504ea317-e0a0-4a72-a92a-ccdcfcbc6893.png');
      opacity: 0.6;
    }

    /* Theme 2: Birds */
    canvas.theme-birds {
      background: linear-gradient(to top, #4B0082, #9400D3);
      box-shadow: inset 0 0 100px rgba(75, 0, 130, 0.6);
    }
    canvas.theme-birds::after {
      background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/ed8cb5e3-2b89-47bb-9c86-80d2a449f7a3.png');
      animation: float 15s linear infinite;
    }

    /* Theme 3: Space */
    canvas.theme-space {
      background: linear-gradient(to top, #000000, #000033);
      box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.8);
    }
    canvas.theme-space::before {
      background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/8f111458-08a8-45c6-afbb-5de16e209a41.png');
      animation: twinkle 5s ease-in-out infinite;
    }
    
    /* Animations */
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    @keyframes moveHorizontal {
      0% { transform: translateX(0); }
      100% { transform: translateX(50px); }
    }

    @keyframes moveVertical {
      0% { transform: translateY(0); }
      100% { transform: translateY(30px); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes glow {
        0% { text-shadow: 0 0 5px #ff0; }
        50% { text-shadow: 0 0 15px #ff0, 0 0 10px #fa0; }
        100% { text-shadow: 0 0 5px #ff0; }
    }

    @keyframes particle-fade {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-20px) scale(0.5); }
    }

    /* Platform Styles (Clouds) */
    .game-platform {
      position: absolute;
      background-color: #ffffff; /* Default, overridden by .platform-cloud */
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 2;
      transition: background-color 0.3s ease;
    }

    .platform-moving-horizontal {
      animation: moveHorizontal 8s ease-in-out infinite alternate;
    }

    .platform-moving-vertical {
      animation: moveVertical 6s ease-in-out infinite alternate;
    }

    .platform-small-obstacle {
      background-color: rgba(255, 255, 255, 0.7) !important;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
    }

    .platform-cloud {
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.9), rgba(240, 240, 240, 0.8));
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1), inset 0 0 10px rgba(255, 255, 255, 0.5);
      position: relative;
      overflow: hidden;
    }

    .platform-cloud::before, .platform-cloud::after {
      content: '';
      position: absolute;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      opacity: 0.7;
      filter: blur(5px);
    }

    .platform-cloud::before {
      width: 70%;
      height: 70%;
      top: -30%;
      left: -20%;
    }

    .platform-cloud::after {
      width: 60%;
      height: 60%;
      bottom: -30%;
      right: -20%;
    }

    .platform-disappearing {
      transition: opacity 0.5s ease-out;
    }

    /* Screen Overlays (Start, Game Over, Pause) */
    #startScreen, #gameOverScreen, #pauseScreen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
      background: rgba(0,0,0,0.8);
      padding: 20px 20px 60px;
      border-radius: 25px;
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
      border: 3px solid #2196F3;
      max-width: 90%;
      box-sizing: border-box;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      z-index: 10;
    }
    #startScreen.show, #gameOverScreen.show, #pauseScreen.show {
        opacity: 1;
    }
    #gameOverScreen {
        border: 3px solid #ff4081;
        padding-top: 70px;
    }
    #startScreen h1, #gameOverScreen h2, #pauseScreen h2 {
        font-size: 1.8em;
        color: #FFD700;
        text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        margin-bottom: 20px;
    }
    #gameOverScreen h2 {
        color: #FF4081;
        position: relative;
        margin-top: 10px;
    }
    #loadingScreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: #000;
  color: #fff;
  font-family: 'Press Start 2P', cursive;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
    /* Character Selection */
    .character-options {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .character-card {
      padding: 15px;
      border-radius: 20px;
      background: rgba(255,255,255,0.15);
      transition: all 0.4s ease;
      cursor: pointer;
      border: 2px solid transparent;
      flex: 1 1 45%;
      min-width: 120px;
      max-width: 180px;
      box-sizing: border-box;
      margin: 5px;
    }
    .character-card:hover {
      transform: translateY(-5px) scale(1.05);
      background: rgba(255,255,255,0.3);
      border: 2px solid #FFD700;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    .character-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #fff;
      margin-bottom: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* Buttons */
    .main-button {
      padding: 15px 30px;
      background: linear-gradient(135deg, #FF416C, #FF4B2B);
      font-size: 1em;
      margin: 20px auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      border: 2px solid #FFD700;
    }

    .back-button {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      margin-top: 20px;
    }

    .character-button, .game-over-button, .main-button, .back-button, .pause-button {
      padding: 10px 20px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(45deg, #2196F3, #00BCD4);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Press Start 2P', cursive;
      font-size: 0.8em;
      text-transform: uppercase;
      letter-spacing: 1px;
      width: 100%;
      box-sizing: border-box;
    }
    .character-button:hover, .main-button:hover, .back-button:hover, .pause-button:hover {
      background: linear-gradient(45deg, #1976D2, #0097A7);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }

    .main-button {
      animation: pulse 1.5s infinite;
    }
    
    /* Score Displays */
    #finalScore {
        font-size: 1.2em;
        margin-bottom: 20px;
        color: #FFD700;
    }
    #highScoreDisplay {
        font-size: 1.4em;
        margin: 15px 0;
        padding: 15px;
        color: #FFD700;
        background: rgba(0,0,0,0.7);
        border-radius: 10px;
        border: 2px solid gold;
        box-shadow: 0 0 15px rgba(255,215,0,0.5);
        text-shadow: 0 0 5px #ff0;
        animation: pulse 1.5s infinite;
        transform: scale(1.1);
    }

    .new-highscore {
        animation: glow 1s infinite, pulse 0.5s infinite !important;
        color: #ffcc00 !important;
        background: rgba(255,0,0,0.2) !important;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }
    .game-over-button {
      background: linear-gradient(45deg, #ff4081, #e91e63);
      font-size: 1em;
      margin-top: 0;
    }
    .game-over-button:hover {
      background: linear-gradient(45deg, #e91e63, #c2185b);
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    /* Popups */
    #coinMilestonePopup {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: auto;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      z-index: 100;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(255,255,0,0.9);
      border: 3px solid #FFD700;
      max-width: 80%;
    }

    #scoreDisplay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        font-family: 'Press Start 2P', cursive;
        font-size: 0.8em;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        border: 2px solid #FFD700;
        z-index: 50;
    }
    #scoreDisplay img {
        width: 20px;
        height: 20px;
        vertical-align: middle;
    }
    #scoreDisplay span {
        margin-left: 3px;
        color: #FFD700;
    }

    #livesDisplay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      border: 2px solid #FFD700;
      z-index: 50;
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .life-icon {
      width: 25px;
      height: 25px;
      filter: drop-shadow(0 0 5px rgba(255,0,0,0.7));
    }

    #pauseButton {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 8px 15px;
      border-radius: 10px;
      font-family: 'Press Start 2P', cursive;
      font-size: 0.8em;
      border: 2px solid #FFD700;
      cursor: pointer;
      z-index: 50;
      display: none; /* Hidden by default, shown when game starts */
    }
    #pauseButton:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    /* Leaderboard Styles */
    .leaderboard-button {
      padding: 10px 15px;
      border: none;
      border-radius: 50px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-family: 'Press Start 2P', cursive;
      font-size: 0.7em;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      border: 2px solid #FFD700;
    }
    .leaderboard-button:hover {
      background: rgba(0,0,0,0.8);
      transform: translateY(-2px);
    }
    #leaderboard {
      margin-top: 10px;
      background: rgba(0,0,0,0.6);
      padding: 15px;
      border-radius: 15px;
      border: 2px solid #FFD700;
      max-height: 200px;
      overflow-y: auto;
      color: #fff;
      font-size: 0.8em;
      text-align: left;
      transition: all 0.3s ease;
    }
    .leaderboard-hidden {
      max-height: 0;
      padding: 0 15px;
      margin: 0;
      border: 0;
      overflow: hidden;
      opacity: 0;
    }
    #leaderboard h3 {
      color: #FFD700;
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }
    #leaderboard ol {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #leaderboard li {
      padding: 5px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.3);
      display: flex;
      justify-content: space-between;
    }
    #leaderboard li:last-child {
      border-bottom: none;
    }
    #leaderboard li span:first-child {
      color: #ADD8E6;
    }
    #leaderboard li span:last-child {
      color: #FFD700;
    }

    /* Creator text styling */
    #creatorText {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 500px;
      text-align: center;
      font-size: 0.7em;
      padding: 10px;
      background: rgba(0,0,0,0.85);
      color: #FFD700;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      border: 2px solid rgba(255,215,0,0.3);
      border-radius: 12px;
      z-index: 100;
      opacity: 0.8;
    }

    /* Game Logo */
    #gameLogo {
      width: 150px;
      height: auto;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 10px rgba(255,215,0,0.8));
    }

    /* Power-up styles */
    .power-up {
      position: absolute;
      width: 30px;
      height: 30px;
      background-color: gold; /* Example color */
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2em;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 5px black;
      box-shadow: 0 0 10px gold;
      z-index: 3;
      animation: pulse 1s infinite;
    }
    .power-up.jump-boost {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      box-shadow: 0 0 15px #FFD700;
      font-size: 1.5em;
      line-height: 1;
    }

    /* Particle effect */
    .particle {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: particle-fade 0.8s forwards;
      pointer-events: none;
      z-index: 4;
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
        #startScreen, #gameOverScreen, #pauseScreen {
            padding: 15px 15px 50px;
            font-size: 16px;
        }
        #gameOverScreen {
            padding-top: 60px;
        }
        #startScreen h1, #gameOverScreen h2, #pauseScreen h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        .character-options {
            flex-direction: column;
            gap: 15px;
        }
        .character-card {
            flex-basis: 80%;
            max-width: 250px;
            padding: 15px;
        }
        .character-image {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }
        .character-button, .game-over-button, .pause-button {
            padding: 10px 15px;
            font-size: 0.7em;
        }
        #finalScore {
            font-size: 1em;
            margin-bottom: 15px;
        }
        #highScoreDisplay {
            font-size: 0.9em;
            margin-top: 8px;
        }
        #scoreDisplay {
            font-size: 0.7em;
            padding: 6px 10px;
            gap: 5px;
        }
        #scoreDisplay img {
            width: 16px;
            height: 16px;
        }
        #livesDisplay {
          padding: 6px 10px;
          gap: 3px;
        }
        .life-icon {
          width: 20px;
          height: 20px;
        }
        #pauseButton {
          padding: 6px 10px;
          font-size: 0.7em;
        }
        #coinMilestonePopup {
            width: 150px;
        }
        #creatorText {
            font-size: 0.6em;
            padding: 8px;
            bottom: 10px;
        }
        #gameLogo {
            width: 120px;
        }
        #leaderboard {
          font-size: 0.7em;
          padding: 10px;
        }
    }

    @media (max-width: 480px) {
        #startScreen, #gameOverScreen, #pauseScreen {
            padding: 10px 10px 40px;
            font-size: 14px;
        }
        #gameOverScreen {
            padding-top: 50px;
        }
        #startScreen h1, #gameOverScreen h2, #pauseScreen h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .game-over-header {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin-bottom: 15px;
        }
        .game-over-header h2 {
          font-size: 1.1em;
        }
          .game-over-icon {
          width: 2em;
          height: 2em;
          border-radius: 50%;
          object-fit: cover;
          border: 2px solid white;
          box-shadow: 0 0 6px rgba(255, 255, 255, 0.4);
          animation: float 3s ease-in-out infinite;
        }
        .character-options {
            gap: 10px;
        }
        .character-card {
            padding: 10px;
            max-width: 200px;
        }
        .character-image {
            width: 70px;
            height: 70px;
            margin-bottom: 8px;
        }
        .character-button, .game-over-button, .pause-button {
            padding: 8px 12px;
            font-size: 0.6em;
        }
        #finalScore {
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        #highScoreDisplay {
            font-size: 0.8em;
            margin-top: 6px;
        }
        #scoreDisplay {
            font-size: 0.6em;
            padding: 5px 8px;
            gap: 3px;
        }
        #scoreDisplay img {
            width: 14px;
            height: 14px;
        }
        #livesDisplay {
          padding: 5px 8px;
          gap: 2px;
        }
        .life-icon {
          width: 18px;
          height: 18px;
        }
        #pauseButton {
          padding: 5px 8px;
          font-size: 0.6em;
        }
        #coinMilestonePopup {
            width: 120px;
        }
        #creatorText {
            font-size: 0.55em;
            padding: 6px;
            bottom: 8px;
        }
        #gameLogo {
            width: 100px;
        }
        #leaderboard {
          font-size: 0.6em;
          padding: 8px;
        }
    }
  </style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196F3">
</head>
<body>
    <div id="loadingScreen">Memuat...</div>  
  <div id="startScreen">
    <img id="gameLogo" src="popup.jpg" alt="Skybound Lovers Logo">
    <h1>Skybound Lovers</h1>
    <div id="mainMenu">
      <button class="main-button" onclick="showCharacterSelect()">Mulai Game</button>
      <div id="characterPreview" style="margin: 20px auto; display: none;">
        <h3>Pilihan Karakter:</h3>
        <img id="selectedCharacterImg" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e99a780f-00a0-4b1a-ac42-516cc062ac52.png" alt="Karakter Terpilih" 
             style="width: 100px; height:100px; border-radius:50%; border:3px solid gold">
      </div>
      <button class="leaderboard-button" onclick="toggleLeaderboard()">⬆ Lihat Leaderboard</button>
      <div id="leaderboard" class="leaderboard-hidden">
        <h3>Leaderboard</h3>
        <ol id="leaderboardList"><li>Belum ada skor.</li></ol>
      </div>
    </div>
    
    <div id="characterSelect" style="display: none;">
      <h2>Pilih Karakter</h2>
      <div class="character-options">
        <div class="character-card" onclick="previewCharacter(1)">
          <img src="laki-laki copy.png" alt="Karakter Laki-laki" class="character-image">
          <p>Laki-laki</p>
        </div>
        <div class="character-card" onclick="previewCharacter(2)">
          <img src="perempuan copyy.png" alt="Karakter Perempuan" class="character-image">
          <p>Perempuan</p>
        </div>
      </div>
      <button class="back-button" onclick="backToMain()">⬅ Kembali</button>
    </div>
  </div>
  <p id="creatorText">
    CREATED BY RAFA STUDIOS 
    <br>© 2025 - ALL RIGHTS RESERVED
  </p>
  <canvas id="gameCanvas" width="400" height="600"></canvas>

  <!-- Score and Coin Display -->
  <div id="scoreDisplay">
    Skor: <span id="currentScore">0</span>
    <img src="coin.png" alt="Koin" style="width: 20px; height: 20px;"> Love: <span id="currentCoinScore">0</span>
  </div>

  <!-- Lives Display -->
  <div id="livesDisplay">
    <img src="heart.png" alt="Life" class="life-icon">
    <img src="heart.png" alt="Life" class="life-icon">
    <img src="heart.png" alt="Life" class="life-icon">
  </div>

  <!-- Pause Button -->
  <button id="pauseButton" onclick="togglePause()">||</button>

  <div id="gameOverScreen">
    <div class="game-over-header">
      <img src="ana.jpg" alt="Decor" class="game-over-icon">
      <h2>Game Over!</h2>
      <img src="farel.jpg" alt="Decor" class="game-over-icon">
    </div>
  
    <p id="finalScore">Skor Akhir: 0</p>
    <p id="highScoreDisplay"></p>
  
    <div class="button-group">
      <button class="game-over-button" onclick="restartGame()">Main Lagi!</button>
      <button class="back-button" onclick="backToStartMenu()">Kembali ke Menu</button>
    </div>
  </div>
  

  <!-- Pause Screen -->
  <div id="pauseScreen">
    <h2>Game Dijeda</h2>
    <div class="button-group">
      <button class="pause-button" onclick="togglePause()">Lanjut</button>
      <button class="back-button" onclick="backToStartMenu()">Kembali ke Menu</button>
    </div>
  </div>

  <!-- Coin Milestone Popup -->
  <img id="coinMilestonePopup" src="popup.jpg" alt="Milestone Koin">

  <script>
    window.addEventListener("load", function () {
  const loadingScreen = document.getElementById("loadingScreen");
  if (loadingScreen) {
    loadingScreen.style.display = "none";
  }
});
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startScreen = document.getElementById("startScreen");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const pauseScreen = document.getElementById("pauseScreen");
    const coinMilestonePopup = document.getElementById("coinMilestonePopup");
    const currentScoreDisplay = document.getElementById("currentScore");
    const currentCoinScoreDisplay = document.getElementById("currentCoinScore");
    const highScoreDisplay = document.getElementById('highScoreDisplay');
    const canvasElement = document.getElementById('gameCanvas');
    const livesDisplay = document.getElementById('livesDisplay');
    const pauseButton = document.getElementById('pauseButton');
    const leaderboardList = document.getElementById('leaderboardList');

    let selectedCharacter = 1;
    const player = {
      x: 180,
      y: 500,
      width: 50,
      height: 50,
      dy: 0,
      jumpPower: -12,
      gravity: 0.5,
      speed: 0,
      maxSpeed: 5,
      image: new Image(),
      jumps: 0, // For double jump
      maxJumps: 2, // For double jump
      isFalling: false // To track if player is falling
    };

    const platforms = [];
    const platformCount = 10;
    let score = 0;
    let lastSafePosition = { x: player.x, y: player.y };
    let coinScore = 0;
    let gameStarted = false;
    let isPaused = false;
    let lastMilestone = 0;
    let highScore = localStorage.getItem('highScore') ? parseInt(localStorage.getItem('highScore')) : 0;
    let lives = 3;
    let animationFrameId; // To store requestAnimationFrame ID

    const coins = [];
    const coinImage = new Image();
    coinImage.src = "coin.png";

    const powerUps = [];
    const powerUpImage = new Image();
    powerUpImage.src = "powerup.png"; // Placeholder for a jump power-up image

    let platformSpeedMultiplier = 1; // For level progression
    let jumpBoostActive = false;
    let originalJumpPower = player.jumpPower;

    // Function to draw the player
    function drawPlayer() {
      if (player.image.src && player.image.complete) {
        ctx.drawImage(player.image, player.x, player.y, player.width, player.height);
      }
    }

    // Function to draw coins
    function drawCoins() {
      coins.forEach(coin => {
        if (!coin.taken) {
          ctx.drawImage(coinImage, coin.x, coin.y, coin.width, coin.height);
        }
      });
    }

    // Function to draw power-ups
    function drawPowerUps() {
      powerUps.forEach(pu => {
        if (!pu.taken) {
          ctx.drawImage(powerUpImage, pu.x, pu.y, pu.width, pu.height);
        }
      });
    }

    // Function to create coins (called when a new platform appears)
    function createCoinOnPlatform(platform) {
      if (platform.type !== "obstacle" && Math.random() < 0.9) { // 90% chance
        const coinCount = Math.min(Math.floor(platform.width / 40), 3); // Max 3 coins based on platform width
        const spacing = platform.width / (coinCount + 1);
        for (let i = 1; i <= coinCount; i++) {
          coins.push({
            x: platform.x + (spacing * i) - 15,
            y: platform.y - 30,
            width: 30,
            height: 30,
            taken: false
          });
        }
      }
    }

    // Function to create power-up
    function createPowerUp(platform) {
      powerUps.push({
        x: platform.x + platform.width / 2 - 15,
        y: platform.y - 40,
        width: 30,
        height: 30,
        type: 'jump-boost',
        taken: false
      });
    }

    // Function to create initial platforms
    function createPlatforms() {
      platforms.length = 0; // Clear existing platforms
      // Initial stable platform
      platforms.push({
        x: 0,
        y: 570,
        width: 400,
        height: 10,
        color: "#ffffff",
        type: "static",
        element: null,
        disappearing: false
      });

      for (let i = 0; i < platformCount; i++) {
        let type = "static";
        let width = Math.max(60, Math.floor(Math.random() * 40) + 60);
        let height = 10;
        let x = Math.random() * (canvas.width - width);
        let y = 600 - (i + 1) * 60;
        let disappearing = false;

        const randomType = Math.random();
        if (randomType < 0.2) {
          type = "horizontal";
          width = 80;
        } else if (randomType < 0.4) {
          type = "vertical";
          width = 70;
        } else if (randomType < 0.5) {
          type = "obstacle";
          width = 40;
          height = 40;
          y -= 20;
        } else if (score >= 100 && randomType < 0.6) { // Disappearing platforms after score 100
          type = "static";
          width = 60;
          height = 10;
          disappearing = true;
        }

        platforms.push({
          x: x,
          y: y,
          width: width,
          height: height,
          color: "#ffffff",
          type: type,
          element: null,
          disappearing: disappearing,
          touched: false // For disappearing platforms
        });
      }
    }

    // Function to draw platforms (create DOM elements)
    function drawPlatforms() {
      // Remove all old platform DOM elements
      const existingPlatforms = document.querySelectorAll('.game-platform');
      existingPlatforms.forEach(el => el.remove());

      platforms.forEach(p => {
        const platformElement = document.createElement('div');
        platformElement.className = 'game-platform platform-cloud';
        platformElement.style.position = 'absolute';
        
        // Get canvas position to correctly place platform DOM elements
        const canvasRect = canvas.getBoundingClientRect();
        platformElement.style.left = `${canvasRect.left + p.x}px`;
        platformElement.style.top = `${canvasRect.top + p.y}px`;
        platformElement.style.width = `${p.width}px`;
        platformElement.style.height = `${p.height}px`;
        platformElement.style.backgroundColor = p.color;

        if (p.type === "horizontal") {
          platformElement.classList.add("platform-moving-horizontal");
        } else if (p.type === "vertical") {
          platformElement.classList.add("platform-moving-vertical");
        } else if (p.type === "obstacle") {
          platformElement.classList.add("platform-small-obstacle");
        }
        if (p.disappearing) {
          platformElement.classList.add("platform-disappearing");
        }

        p.element = platformElement;
        document.body.appendChild(platformElement);
      });
    }

    // Function to move platforms and update their DOM positions
    function movePlatforms(dy) {
      platforms.forEach(p => {
        p.y += dy * platformSpeedMultiplier;
        if (p.element) {
          const canvasRect = canvas.getBoundingClientRect();
          // Update top position based on canvas's current position
          p.element.style.top = `${canvasRect.top + p.y}px`;
          // For moving platforms, their 'left' might also need to be updated if they move relative to canvas
          // For static platforms, their 'left' is fixed relative to canvas
          p.element.style.left = `${canvasRect.left + p.x}px`;
        }

        if (p.y > canvas.height) { // If platform goes off screen
          // Reset platform to top
          p.y = -p.height;
          p.x = Math.random() * (canvas.width - p.width);
          score++;

          // Re-determine platform type randomly
          const randomType = Math.random();
          if (p.element) { // Remove old type classes
            p.element.classList.remove("platform-moving-horizontal", "platform-moving-vertical", "platform-small-obstacle", "platform-disappearing");
            p.element.style.opacity = 1; // Reset opacity for disappearing platforms
          }

          p.disappearing = false; // Reset disappearing state
          p.touched = false;

          if (randomType < 0.2) {
            p.type = "horizontal";
            p.width = 80;
            p.height = 10;
            if (p.element) p.element.classList.add("platform-moving-horizontal");
          } else if (randomType < 0.4) {
            p.type = "vertical";
            p.width = 70;
            p.height = 10;
            if (p.element) p.element.classList.add("platform-moving-vertical");
          } else if (randomType < 0.5) {
            p.type = "obstacle";
            p.width = 40;
            p.height = 40;
            if (p.element) p.element.classList.add("platform-small-obstacle");
            p.y -= 20; // Position slightly higher for obstacle
          } else if (score >= 100 && randomType < 0.6) { // Disappearing platforms after score 100
            p.type = "static";
            p.width = 60;
            p.height = 10;
            p.disappearing = true;
            if (p.element) p.element.classList.add("platform-disappearing");
          } else {
            p.type = "static";
            p.width = 60;
            p.height = 10;
          }
          // Update DOM element dimensions
          if (p.element) {
            p.element.style.width = `${p.width}px`;
            p.element.style.height = `${p.height}px`;
          }

          createCoinOnPlatform(p); // Add coins to new platform

          // Add power-up every 20 coins
          if (coinScore > 0 && coinScore % 20 === 0) {
            createPowerUp(p);
          }
        }
      });

      // Move and remove coins that go off screen
      for (let i = coins.length - 1; i >= 0; i--) {
        coins[i].y += dy * platformSpeedMultiplier;
        if (coins[i].y > canvas.height) {
          coins.splice(i, 1);
        }
      }

      // Move and remove power-ups that go off screen
      for (let i = powerUps.length - 1; i >= 0; i--) {
        powerUps[i].y += dy * platformSpeedMultiplier;
        if (powerUps[i].y > canvas.height) {
          powerUps.splice(i, 1);
        }
      }
    }

    // Function to check player-platform collision
    function checkPlatformCollision() {
      let onPlatform = false;
      platforms.forEach(p => {
        if (!p.element) return; // Skip if DOM element not yet created

        // Get actual position of the platform from its DOM element
        const platformRect = p.element.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();

        // Convert platform position to canvas coordinates
        const pX = platformRect.left - canvasRect.left;
        const pY = platformRect.top - canvasRect.top;
        const pWidth = platformRect.width;
        const pHeight = platformRect.height;

        // Collision detection logic
        if (
          player.dy > 0 && // Player is falling
          player.x + player.width > pX &&
          player.x < pX + pWidth &&
          player.y + player.height > pY &&
          player.y + player.height < pY + pHeight + player.dy // Player lands on top of platform
        ) {
          player.dy = player.jumpPower; // Make player jump
          player.y = pY - player.height; // Snap player to top of platform
          player.jumps = 0; // Reset double jump
          lastSafePosition = { x: player.x, y: player.y };
          onPlatform = true;

          // Particle effect on landing
          createParticles(player.x + player.width / 2, player.y + player.height);

          // Handle disappearing platforms
          if (p.disappearing && !p.touched) {
            p.touched = true;
            setTimeout(() => {
              if (p.element) p.element.style.opacity = 0; // Make it disappear
            }, 200); // Disappear after 200ms
          }
        }
      });
      player.isFalling = !onPlatform && player.dy > 0; // Update isFalling status
    }

    // Function to check player-coin collision
    function checkCoinCollision() {
      for (let i = coins.length - 1; i >= 0; i--) {
        const coin = coins[i];
        if (!coin.taken) {
          if (
            player.x < coin.x + coin.width &&
            player.x + player.width > coin.x &&
            player.y < coin.y + coin.height &&
            player.y + player.height > coin.y
          ) {
            coin.taken = true;
            coinScore++;
            coins.splice(i, 1); // Remove collected coin
          }
        }
      }
    }

    // Function to check player-power-up collision
    function checkPowerUpCollision() {
      for (let i = powerUps.length - 1; i >= 0; i--) {
        const pu = powerUps[i];
        if (!pu.taken) {
          if (
            player.x < pu.x + pu.width &&
            player.x + player.width > pu.x &&
            player.y < pu.y + pu.height &&
            player.y + player.height > pu.y
          ) {
            pu.taken = true;
            powerUps.splice(i, 1); // Remove collected power-up
            activatePowerUp(pu.type);
          }
        }
      }
    }

    // Activate power-up effect
    function activatePowerUp(type) {
      if (type === 'jump-boost') {
        if (!jumpBoostActive) {
          player.jumpPower *= 1.5; // Increase jump power
          jumpBoostActive = true;
          setTimeout(() => {
            player.jumpPower = originalJumpPower; // Reset jump power
            jumpBoostActive = false;
          }, 5000); // Lasts for 5 seconds
        }
      }
    }

    // Create particle effect
    function createParticles(x, y) {
      const numParticles = 5 + Math.floor(Math.random() * 5);
      for (let i = 0; i < numParticles; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const size = Math.random() * 5 + 2; // 2-7px
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        const canvasRect = canvas.getBoundingClientRect();
        particle.style.left = `${canvasRect.left + x + (Math.random() * 10 - 5)}px`;
        particle.style.top = `${canvasRect.top + y + (Math.random() * 10 - 5)}px`;
        
        document.body.appendChild(particle);
        
        // Remove particle after animation
        particle.addEventListener('animationend', () => {
          particle.remove();
        });
      }
    }

    // Main game update loop
    function update() {
      if (!gameStarted || isPaused) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

      player.y += player.dy;
      player.dy += player.gravity;

      player.x += player.speed;

      // Keep player within canvas bounds
      if (player.x < 0) player.x = 0;
      if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

      // Move platforms down if player is high enough
      if (player.y < canvas.height / 2) { // Changed from 300 to canvas.height / 2 for responsiveness
        movePlatforms(3);
        player.y = canvas.height / 2;
      }

      // Check if player falls off screen
      if (player.y > canvas.height) {
        lives--;
        updateLivesDisplay();
        if (lives <= 0) {
          endGame();
          return; // Stop update loop
        } else {
          player.x = lastSafePosition.x;
          player.y = lastSafePosition.y;
          player.dy = 0;
          player.speed = 0;
          player.jumps = 0;

          // Efek visual saat respawn (opsional)
          createParticles(player.x + player.width / 2, player.y + player.height / 2);
        }
      }

      checkPlatformCollision();
      checkCoinCollision();
      checkPowerUpCollision();

      // Coin milestone popup
      const currentMilestone = Math.floor(coinScore / 10) * 10;
      if (currentMilestone > 0 && currentMilestone > lastMilestone) {
        lastMilestone = currentMilestone;
        
        coinMilestonePopup.style.display = 'block';
        setTimeout(() => {
          coinMilestonePopup.style.opacity = 1;
        }, 50);

        setTimeout(() => {
          coinMilestonePopup.style.opacity = 0;
          setTimeout(() => {
            coinMilestonePopup.style.display = 'none';
          }, 500);
        }, 2000);
      }

      // Level progression: increase platform speed
      platformSpeedMultiplier = 1 + Math.floor(score / 50) * 0.1; // Increase speed every 50 score

      // Theme switching
      let newThemeClass = 'theme-buildings';
      if (score > 0) {
        const themeCycle = Math.floor((score - 1) / 50) % 3;
        if (themeCycle === 1) {
          newThemeClass = 'theme-birds';
        } else if (themeCycle === 2) {
          newThemeClass = 'theme-space';
        }
      }

      if (!canvasElement.classList.contains(newThemeClass)) {
        canvasElement.classList.add('no-transition');
        canvasElement.className = ''; // Clear all existing theme classes
        
        setTimeout(() => {
          canvasElement.classList.remove('no-transition');
          if (newThemeClass) {
            canvasElement.classList.add(newThemeClass);
            
            if (newThemeClass === 'theme-birds') {
              showThemePopup("🦅 Birds Theme", "#9C27B0");
            } else if (newThemeClass === 'theme-space') {
              showThemePopup("🌟 Space Theme", "#6a0dad");
            }
          }
        }, 10);
      }

      drawPlayer();
      drawCoins();
      drawPowerUps();
      updateScoreDisplay();
      animationFrameId = requestAnimationFrame(update);
    }

    // End game function
    function endGame() {
      gameStarted = false;
      cancelAnimationFrame(animationFrameId); // Stop the game loop
      document.getElementById('finalScore').textContent = 'Skor Akhir: ' + score;

      updateLeaderboard(score); // Update leaderboard

      if (score > highScore) {
        highScore = score;
        localStorage.setItem('highScore', highScore);
        highScoreDisplay.textContent = '🎉 HIGH SCORE BARU! ' + highScore + ' 🎉';
        highScoreDisplay.classList.add('new-highscore');
      } else {
        highScoreDisplay.textContent = '⭐ SKOR TERTINGGI: ' + highScore + ' ⭐';
        highScoreDisplay.classList.remove('new-highscore');
      }

      document.getElementById('scoreDisplay').style.display = 'none';
      livesDisplay.style.display = 'none';
      pauseButton.style.display = 'none';

      gameOverScreen.style.display = 'block';
      setTimeout(() => {
          gameOverScreen.classList.add('show');
      }, 50);
    }

    // Update score and coin display
    function updateScoreDisplay() {
      currentScoreDisplay.textContent = score;
      currentCoinScoreDisplay.textContent = coinScore;
    }

    // Update lives display
    function updateLivesDisplay() {
      const lifeIcons = livesDisplay.children;
      for (let i = 0; i < lifeIcons.length; i++) {
        if (i < lives) {
          lifeIcons[i].style.opacity = 1;
        } else {
          lifeIcons[i].style.opacity = 0.3; // Dim lost lives
        }
      }
    }

    // Keyboard controls
    document.addEventListener("keydown", e => {
      if (isPaused) return;
      if (e.key === "ArrowLeft") {
        player.speed = -player.maxSpeed;
      } else if (e.key === "ArrowRight") {
        player.speed = player.maxSpeed;
      } else if (e.key === "ArrowUp" || e.key === " ") { // Double jump
        if (player.jumps < player.maxJumps) {
          player.dy = player.jumpPower;
          player.jumps++;
        }
      }
    });

    document.addEventListener("keyup", e => {
      if (isPaused) return;
      if (e.key === "ArrowLeft" || e.key === "ArrowRight") {
        player.speed = 0;
      }
    });

    // Touch controls
    let touchStartX = 0;
    let touchStartY = 0;
    canvas.addEventListener('touchstart', (e) => {
        if (isPaused) return;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        e.preventDefault(); // Prevent scrolling
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        if (isPaused) return;
        const touchCurrentX = e.touches[0].clientX;
        const diffX = touchCurrentX - touchStartX;

        if (Math.abs(diffX) > 10) {
            if (diffX > 0) {
                player.speed = player.maxSpeed;
            } else {
                player.speed = -player.maxSpeed;
            }
        }
        e.preventDefault(); // Prevent scrolling
    }, { passive: false });

    canvas.addEventListener('touchend', (e) => {
        if (isPaused) return;
        player.speed = 0;
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const diffY = touchStartY - touchEndY;

        // Simple tap for jump (if not a horizontal swipe)
        if (Math.abs(touchEndX - touchStartX) < 20 && diffY > 20) { // Detect upward swipe for jump
          if (player.jumps < player.maxJumps) {
            player.dy = player.jumpPower;
            player.jumps++;
          }
        }
    });

    // Start game function
    function startGame() {
      startScreen.classList.remove('show');
      setTimeout(() => {
        startScreen.style.display = "none";
      }, 500);

      document.getElementById('scoreDisplay').style.display = 'flex'; 
      livesDisplay.style.display = 'flex';
      pauseButton.style.display = 'block';
      
      // Initialize game state
      score = 0;
      coinScore = 0;
      lastMilestone = 0;
      lives = 3;
      platformSpeedMultiplier = 1;
      player.jumpPower = originalJumpPower; // Reset jump power
      jumpBoostActive = false;

      platforms.forEach(p => {
        if (p.element) p.element.remove();
      });
      platforms.length = 0;
      coins.length = 0;
      powerUps.length = 0;
      player.y = 500; // Reset player position
      player.dy = 0;
      player.speed = 0;
      player.jumps = 0;

      createPlatforms();
      drawPlatforms(); // Create DOM elements for platforms
      updateLivesDisplay();

      // Reset canvas theme to default
      canvasElement.classList.add('no-transition');
      canvasElement.className = 'theme-buildings';
      setTimeout(() => {
        canvasElement.classList.remove('no-transition');
      }, 10);

      setTimeout(() => {
        gameStarted = true;
        isPaused = false;
        update(); // Start game loop
      }, 500);
    }

    // Toggle pause state
    function togglePause() {
      isPaused = !isPaused;
      if (isPaused) {
        cancelAnimationFrame(animationFrameId); // Stop the game loop
        pauseScreen.style.display = 'block';
        setTimeout(() => {
          pauseScreen.classList.add('show');
        }, 50);
      } else {
        pauseScreen.classList.remove('show');
        setTimeout(() => {
          pauseScreen.style.display = 'none';
          update(); // Resume game loop
        }, 500);
      }
    }

    // Show character selection screen
    function showCharacterSelect() {
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('characterSelect').style.display = 'block';
    }

    // Back to main menu from character select
    function backToMain() {
      document.getElementById('characterSelect').style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
      loadLeaderboard(); // Reload leaderboard when returning to main menu
    }

    // Preview and select character
    function previewCharacter(character) {
      selectedCharacter = character;
      const charImage = character === 1 ? "laki-laki copy.png" : "perempuan copyy.png";
      document.getElementById('selectedCharacterImg').src = charImage;
      document.getElementById('characterPreview').style.display = 'block';
      
      player.image.src = charImage; 
      player.image.onload = () => {
        startGame(); // ⬅ MULAI GAME OTOMATIS DI SINI
        // No longer start game directly from here, user clicks "Mulai Game"
      };
      if (player.image.complete) { // If image is already cached
        // No longer start game directly from here
      }
    }
    
    // Show theme change popup
    function showThemePopup(message, color) {
      const popup = document.createElement('div');
      popup.textContent = message;
      popup.style.position = 'absolute';
      popup.style.top = '50%';
      popup.style.left = '50%';
      popup.style.transform = 'translate(-50%, -50%)';
      popup.style.padding = '15px 30px';
      popup.style.background = color;
      popup.style.color = 'white';
      popup.style.borderRadius = '50px';
      popup.style.fontFamily = "'Press Start 2P', cursive";
      popup.style.fontSize = '0.8em';
      popup.style.zIndex = '1000';
      popup.style.boxShadow = '0 0 20px rgba(255,255,255,0.7)';
      popup.style.animation = 'pulse 1s 2';
      
      document.body.appendChild(popup);
      
      setTimeout(() => {
        popup.style.transition = 'all 0.5s ease-out';
        popup.style.opacity = '0';
        setTimeout(() => popup.remove(), 500);
      }, 1500);
    }

    // Back to start menu from game over screen or pause screen
    function backToStartMenu() {
      gameOverScreen.classList.remove('show');
      pauseScreen.classList.remove('show');
      setTimeout(() => {
        gameOverScreen.style.display = 'none';
        pauseScreen.style.display = 'none';
        startScreen.style.display = 'block';
        setTimeout(() => {
          startScreen.classList.add('show');
        }, 50);
      }, 500);
      // Clear all platform DOM elements when returning to menu
      document.querySelectorAll('.game-platform').forEach(el => el.remove());
      document.querySelectorAll('.power-up').forEach(el => el.remove()); // Remove power-up elements
      document.querySelectorAll('.particle').forEach(el => el.remove()); // Remove particle elements
      
      // Ensure game loop is stopped
      cancelAnimationFrame(animationFrameId);
      gameStarted = false;
      isPaused = false;
      document.getElementById('scoreDisplay').style.display = 'none';
      livesDisplay.style.display = 'none';
      pauseButton.style.display = 'none';
      loadLeaderboard(); // Reload leaderboard when returning to main menu
    }

    // Restart game
    function restartGame() {
      gameOverScreen.classList.remove('show');
      setTimeout(() => {
        gameOverScreen.style.display = 'none';
      }, 500);

      // Clear all platform DOM elements before restarting
      document.querySelectorAll('.game-platform').forEach(el => el.remove());
      document.querySelectorAll('.power-up').forEach(el => el.remove()); // Remove power-up elements
      document.querySelectorAll('.particle').forEach(el => el.remove()); // Remove particle elements

      startGame(); // Re-initialize and start game
    }

    // Leaderboard functions
    function getLeaderboard() {
      const leaderboard = localStorage.getItem('leaderboard');
      return leaderboard ? JSON.parse(leaderboard) : [];
    }

    function saveLeaderboard(leaderboard) {
      localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
    }

    function updateLeaderboard(newScore) {
      let leaderboard = getLeaderboard();
      leaderboard.push({ score: newScore, date: new Date().toLocaleString() });
      leaderboard.sort((a, b) => b.score - a.score); // Sort descending
      leaderboard = leaderboard.slice(0, 5); // Keep top 5 scores
      saveLeaderboard(leaderboard);
      displayLeaderboard();
    }

    function displayLeaderboard() {
      const leaderboard = getLeaderboard();
      leaderboardList.innerHTML = '';
      if (leaderboard.length === 0) {
        leaderboardList.innerHTML = '<li>Belum ada skor.</li>';
        return;
      }
      leaderboard.forEach((entry, index) => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `<span>${index + 1}. ${entry.score}</span><span>${entry.date}</span>`;
        leaderboardList.appendChild(listItem);
      });
    }

    function loadLeaderboard() {
      displayLeaderboard();
    }
    
    function toggleLeaderboard() {
      const leaderboard = document.getElementById('leaderboard');
      const button = document.querySelector('.leaderboard-button');
      if (leaderboard.classList.contains('leaderboard-hidden')) {
        leaderboard.classList.remove('leaderboard-hidden');
        button.textContent = '⬇ Tutup Leaderboard';
      } else {
        leaderboard.classList.add('leaderboard-hidden');
        button.textContent = '⬆ Lihat Leaderboard';
      }
    }

    // Initial setup when page loads
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('scoreDisplay').style.display = 'none'; 
      livesDisplay.style.display = 'none';
      pauseButton.style.display = 'none';
      
      startScreen.style.display = "block";
      setTimeout(() => {
          startScreen.classList.add('show');
      }, 50);

      if (highScore > 0) {
          highScoreDisplay.textContent = '⭐ SKOR TERTINGGI: ' + highScore + ' ⭐';
      } else {
          highScoreDisplay.textContent = '';
      }

      // Set initial canvas theme
      canvasElement.classList.add('theme-buildings');

      // Load leaderboard on startup
      loadLeaderboard();

      // Preload power-up image
      powerUpImage.src = "powerup.png"; // Make sure you have this image
      powerUpImage.onload = () => {
        // Image loaded
      };
      powerUpImage.onerror = () => {
        console.warn("Power-up image 'powerup_jump.png' not found. Using default background color for power-ups.");
        // Fallback: draw a simple circle if image not found
        drawPowerUps = function() {
          powerUps.forEach(pu => {
            if (!pu.taken) {
              ctx.fillStyle = 'gold';
              ctx.beginPath();
              ctx.arc(pu.x + pu.width / 2, pu.y + pu.height / 2, pu.width / 2, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = 'white';
              ctx.font = '15px "Press Start 2P"';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText('J', pu.x + pu.width / 2, pu.y + pu.height / 2 + 2); // 'J' for Jump
            }
          });
        };
      };
    });

    // Service Worker registration for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log("Service Worker terdaftar"))
        .catch(err => console.error("Service Worker gagal:", err));
    }
  </script>
</body>
</html>
